<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="ipfans's Blog" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://www.4async.com').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: true,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="ipfans&#39;s Blog">
<meta property="og:url" content="https://www.4async.com/page/2/index.html">
<meta property="og:site_name" content="ipfans&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ipfans&#39;s Blog">

<link rel="canonical" href="https://www.4async.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ipfans's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b9862358b198078f40d7e1596b7c5968";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ipfans's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2018/06/2018-06-06-sensitive-info-filter-in-golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/2018-06-06-sensitive-info-filter-in-golang/" class="post-title-link" itemprop="url">关于Golang过滤敏感信息的正确姿势</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-06 16:07:00" itemprop="dateCreated datePublished" datetime="2018-06-06T16:07:00+08:00">2018-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/06/2018-06-06-sensitive-info-filter-in-golang/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/06/2018-06-06-sensitive-info-filter-in-golang/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天正好看到一篇关于敏感信息过滤的<a href="https://hackernoon.com/keep-passwords-and-secrets-out-of-your-logs-with-go-a2294a9546ce" target="_blank" rel="noopener">文章</a>，这算做一个interface实际应用的一些举例和应用。</p>
<p>例子中介绍了一种比较常见的使用场景：使用JSON保存数据时的对诸如用户密码等信息进行保护时候应该做的事情。作者以使用JSON格式保存用户账户和密码为例，讲解了使用<code>json.Unmarshaler</code>接口类型过滤敏感信息。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/06/2018-06-06-sensitive-info-filter-in-golang/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2018/05/2018-05-10-consul-graceful-stop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/2018-05-10-consul-graceful-stop/" class="post-title-link" itemprop="url">Consul平滑升级的一点建议</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-10 15:20:00" itemprop="dateCreated datePublished" datetime="2018-05-10T15:20:00+08:00">2018-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/05/2018-05-10-consul-graceful-stop/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/05/2018-05-10-consul-graceful-stop/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我们从 Consul 0.6.x 版本开始使用，中间也遇到的一些各种各样的问题，比较常见的操作问题就是 consul 的升级问题（比如解决 BUG，早期 Consul 的 BUG 也遇到了好几个）。</p>
<p>平滑升级时，我们常见的方式一般为替换 consul 可执行文件，然后执行 Graceful 重启</p>
<p>常见 Consul 的 Graceful leave 的方法有以下两种：</p>
<ol>
<li>发送 <code>SIGINT</code> 信号至 Consul；</li>
<li>连接要升级的 consul，使用命令 <code>consul leave</code> 发送离开命令；</li>
</ol>
<p>这两种方式都会让该节点主动退出集群并结束进程，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[INFO] agent: Caught signal:  terminated</span><br><span class="line">[INFO] agent: Graceful shutdown disabled. Exiting</span><br><span class="line">[INFO] agent: Requesting shutdown</span><br><span class="line">[INFO] consul: shutting down server</span><br><span class="line">[WARN] serf: Shutdown without a Leave</span><br><span class="line">[ERR] agent: Coordinate update error: No cluster leader</span><br><span class="line">[ERR] agent: failed to sync remote state: No cluster leader</span><br><span class="line">[WARN] serf: Shutdown without a Leave</span><br><span class="line">[INFO] manager: shutting down</span><br><span class="line">[INFO] agent: consul server down</span><br><span class="line">[INFO] agent: shutdown complete</span><br><span class="line">[INFO] agent: Stopping DNS server 10.135.218.10:53 (tcp)</span><br><span class="line">[INFO] agent: Stopping DNS server 10.135.218.10:53 (udp)</span><br><span class="line">[INFO] agent: Stopping HTTP server 10.135.218.10:8500 (tcp)</span><br><span class="line">[INFO] agent: Waiting for endpoints to shut down</span><br><span class="line">[INFO] agent: Endpoints down</span><br><span class="line">[INFO] agent: Exit code: 1</span><br></pre></td></tr></table></figure>

<p>之后重新启动 consul 进程即可。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2018/05/2018-05-03-new-domain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/05/2018-05-03-new-domain/" class="post-title-link" itemprop="url">配置新域名</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-03 11:20:00" itemprop="dateCreated datePublished" datetime="2018-05-03T11:20:00+08:00">2018-05-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/05/2018-05-03-new-domain/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/05/2018-05-03-new-domain/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>感谢Github Page终于<a href="https://blog.github.com/2018-05-01-github-pages-custom-domains-https/" target="_blank" rel="noopener">支持了Let’s Encrypt的HTTPS</a>，很久之前购买的域名终于可以再次发光发热了。</p>
<p>新的域名： <a href="https://www.4async.com">https://www.4async.com</a></p>
<p>值得注意的是，在新的域名生效之后，HTTPS需要等待1-2个小时才能启用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2018/04/2018-04-20-setup-wifi-raspberrypi-headless/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/2018-04-20-setup-wifi-raspberrypi-headless/" class="post-title-link" itemprop="url">树莓派无界面配置WiFi</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-20 17:30:00" itemprop="dateCreated datePublished" datetime="2018-04-20T17:30:00+08:00">2018-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/04/2018-04-20-setup-wifi-raspberrypi-headless/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/2018-04-20-setup-wifi-raspberrypi-headless/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>树莓派支持命令行下配置WiFi连接，可以通过编辑 <code>/etc/wpa_supplicant/wpa_supplicant.conf</code> 文件配置对应的WiFi配置。具体的内容可以使用 <code>wpa_passphrase</code> 工具生成对应的配置信息，附加到该文件结尾即可。</p>
<p>假设我存在 <code>SSID</code> 为 <code>testing</code> 密码为 <code>testingPassword</code> 的WiFi网络，我可以使用 <code>wpa_passphrase</code> 生成对应的配置字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ wpa_passphrase &quot;testing&quot; &quot;testingPassword&quot;</span><br><span class="line">network=&#123;</span><br><span class="line">	ssid=&quot;testing&quot;</span><br><span class="line">	#psk=&quot;testingPassword&quot;</span><br><span class="line">	psk=131e1e221f6e06e3911a2d11ff2fac9182665c004de85300f9cac208a6a80531</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">```</span><br></pre></td></tr></table></figure>

<p>当然你可以在 <code>psk</code> 填写原始的密码。</p>
<p>不过在某些极限环境下，我们有可能便装出门，未配置网线等工具，这个时候只有未加入过的WiFi网络，这样如何处理呢？</p>
<p>这种方式与开启SSH方式类似，在制作的SD卡根目录下，新增/修改对应的 <code>wpa_supplicant.conf</code> 文件，添加对应的信息即可。</p>
<p><em>注意，该文件包含默认头部信息不能缺少。如Raspbian 20180418版本完整配置为：</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line">update_config=1</span><br><span class="line"></span><br><span class="line">network=&#123;</span><br><span class="line">	ssid=&quot;testing&quot;</span><br><span class="line">	#psk=&quot;testingPassword&quot;</span><br><span class="line">	psk=131e1e221f6e06e3911a2d11ff2fac9182665c004de85300f9cac208a6a80531</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2018/04/2018-04-20-grpc-performance-optimizing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/04/2018-04-20-grpc-performance-optimizing/" class="post-title-link" itemprop="url">gRPC性能优化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-20 12:00:00" itemprop="dateCreated datePublished" datetime="2018-04-20T12:00:00+08:00">2018-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2018/04/2018-04-20-grpc-performance-optimizing/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/04/2018-04-20-grpc-performance-optimizing/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>我们在项目中逐渐切换使用了gRPC作为服务间调用的主要手段，逐步替换RESTful API在目前我们项目中的使用。在使用过程中，gRPC的效率是我们想对比较关心并且从目前来看相对难以优化的组件，所以本文就是探讨如何能够在不修改gRPC源码的前提下尽量提升gRPC的性能。</p>
<p>grpc官方提供了性能benchmark可以供大家查看，具体的链接可以在 <a href="http://performance-dot-grpc-testing.appspot.com/explore?dashboard=5636470266134528" target="_blank" rel="noopener">gRPC Performance Dashboard</a> 中查看。</p>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>性能测试采用我们的线上标配，目前由于业务量原因，其实性能并不高，这里只是对比参考，建议你在后续处理过程中自行测试。其实最简单的处理方式就是创建多个gRPC client。</p>
<p>单Client处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  client ./client -n 100000 -c 1</span><br><span class="line">2017/08/04 16:49:39 concurrency: 1</span><br><span class="line">requests per client: 100000</span><br><span class="line"></span><br><span class="line">2017/08/04 15:59:39 message size: 581 bytes</span><br><span class="line"></span><br><span class="line">2017/08/04 16:00:04 took 24467 ms for 100000 requests</span><br><span class="line">2017/08/04 16:00:04 sent     requests    : 100000</span><br><span class="line">2017/08/04 16:00:04 received requests    : 100000</span><br><span class="line">2017/08/04 16:00:04 received requests_OK : 100000</span><br><span class="line">2017/08/04 16:00:04 throughput  (TPS)    : 4087</span><br><span class="line">2017/08/04 16:00:04 mean: 244283 ns, median: 241106 ns, max: 6107692 ns, min: 138633 ns, p99: 678374 ns</span><br><span class="line">2017/08/04 16:00:04 mean: 0 ms, median: 0 ms, max: 6 ms, min: 0 ms, p99: 0 ms</span><br></pre></td></tr></table></figure>

<p>修改Client数目为10：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  client ./client -n 100000 -c 10</span><br><span class="line">2017/08/04 16:02:55 concurrency: 10</span><br><span class="line">requests per client: 10000</span><br><span class="line"></span><br><span class="line">2017/08/04 16:02:55 message size: 581 bytes</span><br><span class="line"></span><br><span class="line">2017/08/04 16:03:01 took 6264 ms for 100000 requests</span><br><span class="line">2017/08/04 16:03:01 sent     requests    : 100000</span><br><span class="line">2017/08/04 16:03:01 received requests    : 100000</span><br><span class="line">2017/08/04 16:03:01 received requests_OK : 100000</span><br><span class="line">2017/08/04 16:03:01 throughput  (TPS)    : 15964</span><br><span class="line">2017/08/04 16:03:01 mean: 623814 ns, median: 550812 ns, max: 15572759 ns, min: 98979 ns, p99: 5868493 ns</span><br><span class="line">2017/08/04 16:03:01 mean: 0 ms, median: 0 ms, max: 15 ms, min: 0 ms, p99: 5 ms</span><br></pre></td></tr></table></figure>

<p>修改Client数目为20：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  client ./client -n 100000 -c 20</span><br><span class="line">2017/08/04 16:03:48 concurrency: 20</span><br><span class="line">requests per client: 5000</span><br><span class="line"></span><br><span class="line">2017/08/04 16:03:48 message size: 581 bytes</span><br><span class="line"></span><br><span class="line">2017/08/04 16:03:54 took 6438 ms for 100000 requests</span><br><span class="line">2017/08/04 16:03:54 sent     requests    : 100000</span><br><span class="line">2017/08/04 16:03:54 received requests    : 100000</span><br><span class="line">2017/08/04 16:03:54 received requests_OK : 100000</span><br><span class="line">2017/08/04 16:03:54 throughput  (TPS)    : 15532</span><br><span class="line">2017/08/04 16:03:54 mean: 1277405 ns, median: 1132744 ns, max: 16286260 ns, min: 99258 ns, p99: 8126886 ns</span><br><span class="line">2017/08/04 16:03:54 mean: 1 ms, median: 1 ms, max: 16 ms, min: 0 ms, p99: 8 ms</span><br></pre></td></tr></table></figure>

<p>修改Client数目为15：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  client ./client -n 100000 -c 15</span><br><span class="line">2017/08/04 16:06:57 concurrency: 15</span><br><span class="line">requests per client: 6666</span><br><span class="line"></span><br><span class="line">2017/08/04 16:06:57 message size: 581 bytes</span><br><span class="line"></span><br><span class="line">2017/08/04 16:07:02 took 5528 ms for 99990 requests</span><br><span class="line">2017/08/04 16:07:02 sent     requests    : 99990</span><br><span class="line">2017/08/04 16:07:02 received requests    : 99990</span><br><span class="line">2017/08/04 16:07:02 received requests_OK : 99990</span><br><span class="line">2017/08/04 16:07:02 throughput  (TPS)    : 18087</span><br><span class="line">2017/08/04 16:07:02 mean: 823191 ns, median: 741738 ns, max: 17466607 ns, min: 93208 ns, p99: 5787005 ns</span><br><span class="line">2017/08/04 16:07:02 mean: 0 ms, median: 0 ms, max: 17 ms, min: 0 ms, p99: 5 ms</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2017/08/2017-08-02-install-face-recognition-on-osx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/08/2017-08-02-install-face-recognition-on-osx/" class="post-title-link" itemprop="url">OSX 下安装 face_recognition</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-02 18:30:00" itemprop="dateCreated datePublished" datetime="2017-08-02T18:30:00+08:00">2017-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/08/2017-08-02-install-face-recognition-on-osx/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/08/2017-08-02-install-face-recognition-on-osx/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>face_recognition 是一个热门的人脸识别库，常年占据 <a href="https://github.com/trending/python" target="_blank" rel="noopener">Github Trending Python 子类</a>的 Top10。</p>
<p>在官方文档中，介绍安装 face_recognition 步骤非常简单，只需要执行 <code>pip install face_recognition</code> 就可以了，实际在安装过程中 face_recognition 有一些非 Python 依赖，需要单独安装，本文就对内容进行一个简单介绍，权作记录，方便大家手动安装时提前规避。文章基于 OSX 10.12.6+pyenv+python3.6.2 介绍。</p>
<h2 id="问题在哪里？"><a href="#问题在哪里？" class="headerlink" title="问题在哪里？"></a>问题在哪里？</h2><p>face_recognition 的依赖大部分都比较好安装，只有一个库例外，那就是 <code>dlib</code> 这个依赖。这个依赖需要安装 <code>boost</code> 和 <code>boost-python</code> 两个非 Python 依赖。</p>
<h2 id="安装-Boost-和-boost-python"><a href="#安装-Boost-和-boost-python" class="headerlink" title="安装 Boost 和 boost-python"></a>安装 Boost 和 boost-python</h2><p>这两个库可以通过 <code>Homebrew</code> 快速安装，使用如下命令进行安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install boost</span><br><span class="line">brew install boost-python --with-python3</span><br></pre></td></tr></table></figure>

<p>需要注意的是，如果是 Python3 使用，需要额外参数，使用源码编译安装。如果使用 Python2 可以使用 Homebrew 的预编译包。</p>
<h2 id="确认-Python"><a href="#确认-Python" class="headerlink" title="确认 Python"></a>确认 Python</h2><p>dlib 要求 Python 编译时使用 <code>--enable-shared</code> 参数编译，默认情况下，pyenv 未启用该参数，因此编译需要使用下面参数进行 Python 重新编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYTHON_CONFIGURE_OPTS=&quot;--with-dtrace --enable-shared&quot; pyenv install 3.6.2</span><br></pre></td></tr></table></figure>

<p>前面一个参数是我一直编译 Python 3.6 使用的参数，方便使用 DTrace 监控 Python 的执行。具体的作用可以参考我<a href="https://ipfans.github.io/2016/09/tracing-python-program-with-dtrace/" target="_blank" rel="noopener">之前的文章</a>。</p>
<p>这样还没有完，因为 dlib 的代码问题，对默认 Python3.6 的 library 识别有问题，因此需要将 Python 安装目录下的 lib/libpython3.6m.dylib 复制为 lib/libpython3.6.dylib。一般 pyenv 目录为 <code>~/.pyenv/versions/3.6.2/lib/</code></p>
<h2 id="安装-face-recognition"><a href="#安装-face-recognition" class="headerlink" title="安装 face_recognition"></a>安装 face_recognition</h2><p>接下来就可以使用 pip 正常安装 face_recognition 了，其中 <code>dlib</code> 编译还是需要消耗一些时间的，需要耐心等待。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2017/07/2017-07-31-mongodb-optimizing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/07/2017-07-31-mongodb-optimizing/" class="post-title-link" itemprop="url">一些 MongoDB 的坑</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-07-31 18:45:00" itemprop="dateCreated datePublished" datetime="2017-07-31T18:45:00+08:00">2017-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/07/2017-07-31-mongodb-optimizing/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/07/2017-07-31-mongodb-optimizing/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>由于过去的历史原因，我们使用的默认 DB 是 MongoDB 数据库。MongoDB 数据库本身在支持非格式化的数据存储方面有比较大的优势，也不需要额外做很多的 Schema Migration，在我们项目初期，数据存储结构变动频繁时帮助非常大。</p>
<p>但是，随着我们的业务不断增长，我们也遇到了一些问题，这篇文章总结了一些我们在过去的过程中出现的一些问题或者失误，帮助大家在实践过程中进行规避。</p>
<h2 id="集合使用不当问题"><a href="#集合使用不当问题" class="headerlink" title="集合使用不当问题"></a>集合使用不当问题</h2><p>在使用 MongoDB 过程中，我们创建了大量的集合。这种情况在 WiredTriger 引擎下创建大量零散文件。这个在使用过程中暂时未对我们造成实际的业务较大影响，但是从实际使用而言，对整体数据库性能、后续主从复制集群同步，都是有一定影响的。在实际应用过程中应该避免：拥有过多 DB、一个 DB 下有过多 Collection，这样都会导致部分指令的性能大幅度下滑。同时，过多的 DB 也会导致主从同步失败 (listDatabse 超时导致失败，从库退出)。</p>
<h2 id="数据库索引建立"><a href="#数据库索引建立" class="headerlink" title="数据库索引建立"></a>数据库索引建立</h2><p>MongoDB Collection 索引建立功能支持前台创建模式与后台创建模式两种。默认模式为前台创建模式。这种模式下会发生：DB 被锁，主库所有读写被禁止、从库无法访问。从另一方面来说，会导致业务系统的数据库访问受到影响。虽然前台创建模式效率更高，但是如果是线上操作，并且有一定数量级，创建索引时需要添加 <code>{background:true}</code> 让创建索引操作转换为后台操作，尽管时间较长，但是对业务影响较小。同时，该操作也应该在业务量小时进行。</p>
<h2 id="数据库主从切换"><a href="#数据库主从切换" class="headerlink" title="数据库主从切换"></a>数据库主从切换</h2><p>虽然 MongoDB 的 Replica Set 功能可以方便的进行自动主从切换。但是实际使用过程中，我们也会遇到一些需要手工进行主从库切换的情况。比如，进行进行版本升级修复 BUG 或者安全漏洞。但是如果这个时候强行进行 Primary 的重启，则可能会出现未同步至 Secondary 的数据丢失的情况（血泪教训）。这种情况下，重启集群的方式是，优先进行 Secondary 的更新操作，在 Secondary 更新完成后，对 Primary 进行 <a href="https://docs.mongodb.com/manual/reference/method/rs.stepDown/" target="_blank" rel="noopener">stepDown</a> 操作，等待主节点降级成为 Secondary 节点，之后进行操作。这样的好处是不会丢失数据。但是如果主从数据差异较大时，有可能会造成降级失败，此时可以重复执行 stepDown 直至成功。还有一个值得注意的是，即便 Secondary 可以停机维护，但是仍旧有可能丢数据，这个与 <code>oplog</code> 大小有关，我们放在后面说。</p>
<h2 id="慢查询问题"><a href="#慢查询问题" class="headerlink" title="慢查询问题"></a>慢查询问题</h2><p>慢查询的记录可以通过 Profiling 进行记录，这部分资料比较多，可以通过 <code>db.setProfilingLevel()</code> 进行管理。同时，主动分析也可以通过 <code>explain</code> 进行预分析。这一部分资料比较多，我这里就不再啰嗦了。但是还有一个问题是，部分慢查询操作不会随着客户端断开中断执行，需要通过 <code>db.currentOp()</code> 和 <code>db.killOp()</code> 功能干掉长时间执行、浪费资源的操作。</p>
<h2 id="主从同步延迟问题"><a href="#主从同步延迟问题" class="headerlink" title="主从同步延迟问题"></a>主从同步延迟问题</h2><p>主从同步问题是比较常见的延迟问题了，主要问题都是出在 <code>oplog</code> 上。毕竟主从同步机制都是通过此实现的。<code>oplog</code> 是固定大小的集合，如果满了，就会自动删除老的数据。</p>
<p><img src="https://ws1.sinaimg.cn/large/69e37fdbgy1fi38mlkzgvj20kt0u277g.jpg" alt></p>
<p>这里可以看到，此处查询 <code>oplog</code> 操作记录到从库同步，已经执行了 194 毫秒。</p>
<p>上面我们提到，当 Secondary 停机维护时也可能出现问题，就是因为，当 <code>oplog</code> 不足时，那么就有可能会导致数据同步失败。因此一般数据库停机维护操作，也应该放在业务量小的时候进行。不过 <code>oplog</code> 是可以调整的，可以参考 <a href="https://docs.mongodb.com/v3.2/tutorial/change-oplog-size" target="_blank" rel="noopener">官方文档</a> 进行调整。注意，这需要重启数据库来执行。</p>
<p>主从同步延迟一般出现的情况都是数据出现大量插入和修改的情况。在 Secondary 进行 <code>oplog</code> 重放时，开销会大于 <code>Primary</code> 进行操作的开销。这种情况会产生大量的 <code>oplog</code>（每条修改记录一条，非操作），记录越多，同步速度越慢。同时，某些操作也会大幅度提高单条记录的同步成本，比如 <code>$inc</code>、<code>$push</code> 等等会让同步更慢。如果你对数据库中较大量数据进行 <code>$set</code> 操作，同样也会造成数据延迟。我们的一位工程师就因为这样曾经造成了分钟级别的延迟，教训也是非常惨痛的。这种操作比较频繁时，我们可以通过调整 <code>replWriterThreadCount</code> 参数进行 Secondary 重放线程数量调整。在 MongoDB 中默认为 16，这个可以根据情况进行具体调整。不过该参数为 MongoDB 启动参数，调整该参数会要求重启 MongoDB。另外一个值得注意的是这种操作会加大内存开销，如果内存紧张时也需要注意。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2017/04/2017-05-19-grpc-call-timeout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/2017-05-19-grpc-call-timeout/" class="post-title-link" itemprop="url">gRPC 调用超时控制</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-04-06 18:00:00" itemprop="dateCreated datePublished" datetime="2017-04-06T18:00:00+08:00">2017-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/04/2017-05-19-grpc-call-timeout/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/04/2017-05-19-grpc-call-timeout/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我们在进行服务间调用时广泛采用 gRPC 作为主要的调用协议，借助 gRPC 的模块化与语言无关的特性，可以在我们拓展多语言模块之间提供更好的支持。但是我们在使用 gRPC 之中也出现了一些问题，这些问题会做一些记录，希望可以与大家一起沟通与交流。</p>
<p>某日，我们的客服反馈，我们的基础设施操作工具出现了长时间无响应的问题。该问题出现在我们对某些设备进行 OTA 升级时，操作长时间无返回，与之前预期的 10 秒内返回存在较大出入。经过我们的工程师分析，我们发现在 gRPC 处理过程中，我们的操作工具通过 gRPC 调用远程服务端接口时，接口长时间没有返回结果。</p>
<p>我们首先怀疑是 gRPC 调用过程中出现了连接问题。gRPC 过程中可能由于多种原因导致连接断开或者服务器无法连接。在调用 gRPC 方法过程中，我们可以通过 <figure class="highlight plain"><figcaption><span>方式进行快速失败。实际上，这个值默认情况下为 ```true```。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">那么接下来我们就需要从调用从使用角度上寻找问题。我们使用过程中默许服务端在处理某些操作时进行较长时间操作（如长时间操作），但是从客户端角度而言，部分操作正常情况下我们是希望可以在有预定特定环境下达到某些时间仍旧未返回结果可以标记为结果失败。这样就需要通过 gRPC 的机制进行调控。由于目前我们的接口很多情况下调用接口实际为硬件接口，因此，我们采用通过控制 gRPC 客户端接口超时的方法控制。</span><br><span class="line"></span><br><span class="line">在 gRPC 中，提供了 MethodConfig 用于控制每个方法的超时时间，这样可以对不同的 RPC 方法设置超时。</span><br><span class="line"></span><br><span class="line">下面，我们用 [官方的 gRPC 示例](https://github.com/grpc/grpc-go/tree/master/examples/helloworld) 演示如何进行调用超时控制。</span><br><span class="line"></span><br><span class="line">首先，我们在 ```examples/helloworld/greeter_server/main.go``` 中的 ```SayHello``` 中添加一个长时间操作模拟：```time.Sleep(10*time.Second)```。</span><br><span class="line"></span><br><span class="line">这时，如果我们需要客户端在 5 秒以内返回结果，应该如何操作呢？</span><br><span class="line"></span><br><span class="line">那么我们修改 ```examples/helloworld/greeter_client/main.go``` 中的 ```main```，添加超时处理内容：</span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line">func main() &#123;</span><br><span class="line">	// Set up method timeout configure.</span><br><span class="line">	var wg sync.WaitGroup</span><br><span class="line">	wg.Add(1)</span><br><span class="line">	ch := make(chan grpc.ServiceConfig)</span><br><span class="line">	go func() &#123;defer wg.Done()</span><br><span class="line">		mc := grpc.MethodConfig&#123;</span><br><span class="line">			WaitForReady: true,</span><br><span class="line">			Timeout:      5 * time.Second,</span><br><span class="line">		&#125;</span><br><span class="line">		m := make(map[string]grpc.MethodConfig)</span><br><span class="line">		// 格式：/PackageName/ServiceName/MethodName</span><br><span class="line">		m[&quot;/helloworld.Greeter/SayHello&quot;] = mc</span><br><span class="line">		sc := grpc.ServiceConfig&#123;Methods: m,&#125;</span><br><span class="line">		ch &lt;- sc&#125;()</span><br><span class="line">	// Set up a connection to the server.</span><br><span class="line">	conn, err := grpc.Dial(address, grpc.WithInsecure())</span><br><span class="line">	if err != nil &#123;log.Fatalf(&quot;did not connect: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	defer conn.Close()</span><br><span class="line">	c := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">	// Contact the server and print out its response.</span><br><span class="line">	name := defaultName</span><br><span class="line">	if len(os.Args) &gt; 1 &#123;name = os.Args[1]</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(&quot;Starting...\n&quot;)   // 明确执行时间</span><br><span class="line">	r, err := c.SayHello(context.Background(), &amp;pb.HelloRequest&#123;Name: name&#125;)</span><br><span class="line">	if err != nil &#123;log.Fatalf(&quot;could not greet: %v&quot;, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(&quot;Greeting: %s&quot;, r.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中根据 MethodConfig 对应 map 结构，可以找到对应方法，对指定方法设置超时时间。最后，执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017/05/19 15:59:11 Starting call...</span><br><span class="line">2017/05/19 15:59:17 could not greet: rpc error: code = DeadlineExceeded desc = context deadline exceeded</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2017/02/2017-02-19-analyzing-pronto-cycleshare-data-with-python-and-pandas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/2017-02-19-analyzing-pronto-cycleshare-data-with-python-and-pandas/" class="post-title-link" itemprop="url">使用 Python 和 Pandas 分析 Pronto CycleShare 数据</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-02-19 18:00:00" itemprop="dateCreated datePublished" datetime="2017-02-19T18:00:00+08:00">2017-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/02/2017-02-19-analyzing-pronto-cycleshare-data-with-python-and-pandas/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/02/2017-02-19-analyzing-pronto-cycleshare-data-with-python-and-pandas/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是一篇非常不错的 <a href="https://jakevdp.github.io/blog/2015/10/17/analyzing-pronto-cycleshare-data-with-python-and-pandas/" target="_blank" rel="noopener">pandas 分析入门文章</a>，在此简单翻译摘录如下。</p>
<hr>
<p>本周，西雅图的自行车共享系统 Pronto CycleShare 一周岁了。 为了庆祝这一点，Pronto 提供了从第一年的数据缓存，并宣布了 <a href="http://www.prontocycleshare.com/datachallenge" target="_blank" rel="noopener">Pronto Cycle Share 的数据分析挑战</a>。</p>
<p>你可以用很多工具分析这些数据，但我的选择工具是 Python。 在这篇文章中，我想展示如何开始分析这些数据，并使用 PyData 技术栈，即 <a href="http://www.numpy.org/" target="_blank" rel="noopener">NumPy</a>，<a href="http://pandas.pydata.org/" target="_blank" rel="noopener">Pandas</a>，<a href="http://matplotlib.org/" target="_blank" rel="noopener">Matplotlib</a> 和 <a href="http://seaborn.pydata.org/index.html" target="_blank" rel="noopener">Seaborn</a> 与其他可用的数据源。</p>
<p>这篇文章以 Jupyter Notebook 形式组织，它是一种开放的文档格式。结合了文本、代码、数据和图形，并且通过 Web 浏览器查看。本文中的内容可以下载 <a href="http://jakevdp.github.io/downloads/notebooks/ProntoData.ipynb" target="_blank" rel="noopener">对应的 Notebook 文件</a>，并通过 Jupyter 打开。</p>
<h2 id="下载-Pronto-的数据"><a href="#下载-Pronto-的数据" class="headerlink" title="下载 Pronto 的数据"></a>下载 Pronto 的数据</h2><p>我们可以从 <a href="http://www.prontocycleshare.com/datachallenge" target="_blank" rel="noopener">Pronto 官网</a> 下载对应的 <a href="https://s3.amazonaws.com/pronto-data/open_data_year_one.zip" target="_blank" rel="noopener">数据文件</a>。总下载大约 70MB，解压缩的文件大约 900MB。</p>
<p>接下来我们需要导入一些 Python 包：</p>
<p>In [2]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns; sns.set()</span><br></pre></td></tr></table></figure>

<p>现在我们使用 Pandas 加载所有的行程记录：</p>
<p>In [3]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">trips = pd.read_csv(<span class="string">'2015_trip_data.csv'</span>,</span><br><span class="line">                    parse_dates=[<span class="string">'starttime'</span>, <span class="string">'stoptime'</span>],</span><br><span class="line">                    infer_datetime_format=<span class="literal">True</span>)</span><br><span class="line">trips.head()</span><br></pre></td></tr></table></figure>

<p>Out[3]:</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trip_id</th>
      <th>starttime</th>
      <th>stoptime</th>
      <th>bikeid</th>
      <th>tripduration</th>
      <th>from_station_name</th>
      <th>to_station_name</th>
      <th>from_station_id</th>
      <th>to_station_id</th>
      <th>usertype</th>
      <th>gender</th>
      <th>birthyear</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>431</td>
      <td>2014-10-13 10:31:00</td>
      <td>2014-10-13 10:48:00</td>
      <td>SEA00298</td>
      <td>985.935</td>
      <td>2nd Ave &amp; Spring St</td>
      <td>Occidental Park / Occidental Ave S &amp; S Washing...</td>
      <td>CBD-06</td>
      <td>PS-04</td>
      <td>Annual Member</td>
      <td>Male</td>
      <td>1960</td>
    </tr>
    <tr>
      <th>1</th>
      <td>432</td>
      <td>2014-10-13 10:32:00</td>
      <td>2014-10-13 10:48:00</td>
      <td>SEA00195</td>
      <td>926.375</td>
      <td>2nd Ave &amp; Spring St</td>
      <td>Occidental Park / Occidental Ave S &amp; S Washing...</td>
      <td>CBD-06</td>
      <td>PS-04</td>
      <td>Annual Member</td>
      <td>Male</td>
      <td>1970</td>
    </tr>
    <tr>
      <th>2</th>
      <td>433</td>
      <td>2014-10-13 10:33:00</td>
      <td>2014-10-13 10:48:00</td>
      <td>SEA00486</td>
      <td>883.831</td>
      <td>2nd Ave &amp; Spring St</td>
      <td>Occidental Park / Occidental Ave S &amp; S Washing...</td>
      <td>CBD-06</td>
      <td>PS-04</td>
      <td>Annual Member</td>
      <td>Female</td>
      <td>1988</td>
    </tr>
    <tr>
      <th>3</th>
      <td>434</td>
      <td>2014-10-13 10:34:00</td>
      <td>2014-10-13 10:48:00</td>
      <td>SEA00333</td>
      <td>865.937</td>
      <td>2nd Ave &amp; Spring St</td>
      <td>Occidental Park / Occidental Ave S &amp; S Washing...</td>
      <td>CBD-06</td>
      <td>PS-04</td>
      <td>Annual Member</td>
      <td>Female</td>
      <td>1977</td>
    </tr>
    <tr>
      <th>4</th>
      <td>435</td>
      <td>2014-10-13 10:34:00</td>
      <td>2014-10-13 10:49:00</td>
      <td>SEA00202</td>
      <td>923.923</td>
      <td>2nd Ave &amp; Spring St</td>
      <td>Occidental Park / Occidental Ave S &amp; S Washing...</td>
      <td>CBD-06</td>
      <td>PS-04</td>
      <td>Annual Member</td>
      <td>Male</td>
      <td>1971</td>
    </tr>
  </tbody>
</table>

<p>这个行程数据集的每一行是由一个人单独骑行，共包含超过 140,000 条数据。</p>
<h2 id="探索时间与行程的关系"><a href="#探索时间与行程的关系" class="headerlink" title="探索时间与行程的关系"></a>探索时间与行程的关系</h2><p>让我们先看看一年中每日行程次数的趋势。</p>
<p>In [4]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Find the start date</span></span><br><span class="line">ind = pd.DatetimeIndex(trips.starttime)</span><br><span class="line">trips[<span class="string">'date'</span>] = ind.date.astype(<span class="string">'datetime64'</span>)</span><br><span class="line">trips[<span class="string">'hour'</span>] = ind.hour</span><br></pre></td></tr></table></figure>

<p>In [5]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Count trips by date</span></span><br><span class="line">by_date = trips.pivot_table(<span class="string">'trip_id'</span>, aggfunc=<span class="string">'count'</span>,</span><br><span class="line">                            index=<span class="string">'date'</span>,</span><br><span class="line">                            columns=<span class="string">'usertype'</span>, )</span><br></pre></td></tr></table></figure>

<p>In [6]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots(<span class="number">2</span>, figsize=(<span class="number">16</span>, <span class="number">8</span>))</span><br><span class="line">fig.subplots_adjust(hspace=<span class="number">0.4</span>)</span><br><span class="line">by_date.iloc[:, <span class="number">0</span>].plot(ax=ax[<span class="number">0</span>], title=<span class="string">'Annual Members'</span>);</span><br><span class="line">by_date.iloc[:, <span class="number">1</span>].plot(ax=ax[<span class="number">1</span>], title=<span class="string">'Day-Pass Users'</span>);</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvpy4sgpyj20pu0ebjuf" alt></p>
<p>此图显示每日趋势，以年费用户（上图）和临时用户（下图）分隔。 根据图标，我们可以获得几个结论：</p>
<ul>
<li>4 月份短期使用的临时用户大幅增加可能是由于 <a href="http://www.planetizen.com/node/75958/seattle-sets-bikeshare-record-apa-town" target="_blank" rel="noopener">美国规划协会全国会议</a> 在西雅图市中心举行。 其他一个比较接近的时间是 7 月 4 日周末。</li>
<li>临时用户呈现了一个与季节相关联的稳定的衰退趋势; 年费用户的使用没有随着秋天的来临而显着减少。</li>
<li>年费用户和临时用户似乎都显示出明显的每周趋势。</li>
</ul>
<p>现在放大每周趋势，看一下所有的骑乘都是按照星期几分部的。由于 2015 年 1 月份左右模式的变化，我们按照年份和星期几进行拆分：</p>
<p>In [7]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">by_weekday = by_date.groupby([by_date.index.year,</span><br><span class="line">                              by_date.index.dayofweek]).mean()</span><br><span class="line">by_weekday.columns.name = <span class="literal">None</span>  <span class="comment"># remove label for plot</span></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">16</span>, <span class="number">6</span>), sharey=<span class="literal">True</span>)</span><br><span class="line">by_weekday.loc[<span class="number">2014</span>].plot(title=<span class="string">'Average Use by Day of Week (2014)'</span>, ax=ax[<span class="number">0</span>]);</span><br><span class="line">by_weekday.loc[<span class="number">2015</span>].plot(title=<span class="string">'Average Use by Day of Week (2015)'</span>, ax=ax[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">for</span> axi <span class="keyword">in</span> ax:</span><br><span class="line">    axi.set_xticklabels([<span class="string">'Mon'</span>, <span class="string">'Tues'</span>, <span class="string">'Wed'</span>, <span class="string">'Thurs'</span>, <span class="string">'Fri'</span>, <span class="string">'Sat'</span>, <span class="string">'Sun'</span>])</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvtq0o8jaj20q20aimxv" alt></p>
<p>我们看到了一个互补的模式：年费用户倾向于工作日使用他们的自行车（即作为通勤的一部分），而临时用户倾向于在周末使用他们的自行车。这种模式甚至在 2015 年年初都没有特别的体现出来，尤其是年费用户：似乎在头几个月，用户还没有使用 Pronto 的通勤习惯。</p>
<p>查看平日和周末的平均每小时骑行也很有趣。这需要一些操作：</p>
<p>In [8]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># count trips by date and by hour</span></span><br><span class="line">by_hour = trips.pivot_table(<span class="string">'trip_id'</span>, aggfunc=<span class="string">'count'</span>,</span><br><span class="line">                            index=[<span class="string">'date'</span>, <span class="string">'hour'</span>],</span><br><span class="line">                            columns=<span class="string">'usertype'</span>).fillna(<span class="number">0</span>).reset_index(<span class="string">'hour'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># average these counts by weekend</span></span><br><span class="line">by_hour[<span class="string">'weekend'</span>] = (by_hour.index.dayofweek&gt;= <span class="number">5</span>)</span><br><span class="line">by_hour = by_hour.groupby([<span class="string">'weekend'</span>, <span class="string">'hour'</span>]).mean()</span><br><span class="line">by_hour.index.set_levels([[<span class="string">'weekday'</span>, <span class="string">'weekend'</span>],</span><br><span class="line">                          [<span class="string">"&#123;0&#125;:00"</span>.format(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">24</span>)]],</span><br><span class="line">                         inplace=<span class="literal">True</span>);</span><br><span class="line">by_hour.columns.name = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>现在我们可以绘制结果来查看每小时的趋势：</p>
<p>In [9]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots(<span class="number">1</span>, <span class="number">2</span>, figsize=(<span class="number">16</span>, <span class="number">6</span>), sharey=<span class="literal">True</span>)</span><br><span class="line">by_hour.loc[<span class="string">'weekday'</span>].plot(title=<span class="string">'Average Hourly Use (Mon-Fri)'</span>, ax=ax[<span class="number">0</span>])</span><br><span class="line">by_hour.loc[<span class="string">'weekend'</span>].plot(title=<span class="string">'Average Hourly Use (Sat-Sun)'</span>, ax=ax[<span class="number">1</span>])</span><br><span class="line">ax[<span class="number">0</span>].set_ylabel(<span class="string">'Average Trips per Hour'</span>);</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvtx6xmpqj20q30axgmm" alt></p>
<p>我们看到一个 “通勤” 模式和一个 “娱乐” 模式之间的明显区别:“通勤” 模式在早上和晚上急剧上升，而 “娱乐” 模式在下午的时候有一个宽峰。 有趣的是，年费会员在周末的行为似乎与临时用户在周末的行为几乎相同。</p>
<h2 id="旅行时间"><a href="#旅行时间" class="headerlink" title="旅行时间"></a>旅行时间</h2><p>接下来，我们来看看旅行的持续时间。 Pronto 免费骑行最长可达 30 分钟; 任何长于此的单次使用，在前半个小时都会产生几美元的使用费，此后每小时大约需要十美元。</p>
<p>让我们看看年费会员和临时使用者的旅行持续时间的分布：</p>
<p>In [10]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">trips[<span class="string">'minutes'</span>] = trips.tripduration / <span class="number">60</span></span><br><span class="line">trips.groupby(<span class="string">'usertype'</span>)[<span class="string">'minutes'</span>].hist(bins=np.arange(<span class="number">61</span>), alpha=<span class="number">0.5</span>, normed=<span class="literal">True</span>);</span><br><span class="line">plt.xlabel(<span class="string">'Duration (minutes)'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'relative frequency'</span>)</span><br><span class="line">plt.title(<span class="string">'Trip Durations'</span>)</span><br><span class="line">plt.text(<span class="number">34</span>, <span class="number">0.09</span>,<span class="string">"Free Trips\n\nAdditional Fee"</span>, ha=<span class="string">'right'</span>,</span><br><span class="line">         size=<span class="number">18</span>, rotation=<span class="number">90</span>, alpha=<span class="number">0.5</span>, color=<span class="string">'red'</span>)</span><br><span class="line">plt.legend([<span class="string">'Annual Members'</span>, <span class="string">'Short-term Pass'</span>])</span><br><span class="line"></span><br><span class="line">plt.axvline(<span class="number">30</span>, linestyle=<span class="string">'--'</span>, color=<span class="string">'red'</span>, alpha=<span class="number">0.3</span>);</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvu4jj5p0j20e20a5aab" alt></p>
<p>在这里，我添加了一个红色的虚线，分开免费骑乘（左）和付费骑乘（右）。看来，年费用户对系统规则更加了解：只有行程分布的一小部分超过 30 分钟。另一方面，大约四分之一的临时用户时间超过半小时限制，并收取额外费用。 我的预期是，这些临时用户不能很好理解这种定价结构，并且可能会因为不开心的体验不再使用。</p>
<h2 id="估计行程距离"><a href="#估计行程距离" class="headerlink" title="估计行程距离"></a>估计行程距离</h2><p>看看旅行的距离也十分有趣。Pronto 发布的数据中不包括行车的距离，因此我们需要通过其他来源来确定。让我们从加载行车数据开始 - 因为一些行程在 Pronto 的服务点之间开始和结束，我们将其添加为一个 “车站”：</p>
<p>In [11]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stations = pd.read_csv(<span class="string">'2015_station_data.csv'</span>)</span><br><span class="line">pronto_shop = dict(id=<span class="number">54</span>, name=<span class="string">"Pronto shop"</span>,</span><br><span class="line">                   terminal=<span class="string">"Pronto shop"</span>,</span><br><span class="line">                   lat=<span class="number">47.6173156</span>, long=<span class="number">-122.3414776</span>,</span><br><span class="line">                   dockcount=<span class="number">100</span>, online=<span class="string">'10/13/2014'</span>)</span><br><span class="line">stations = stations.append(pronto_shop, ignore_index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>现在我们需要找到两对纬度 / 经度坐标之间的骑车距离。幸运的是，Google 地图有一个距离 API，我们可以免费使用。</p>
<p>从文档中知道，我们每天免费使用的限制为每天最多 2500 个距离，每 10 秒最多 100 个距离。现在有 55 个站，我们有（55 * 54/2） = 1485 个非零距离，所以我们可以在几天内免费查询所有车站之间的距离。</p>
<p>为此，我们一次查询一行，在查询之间等待 10 + 秒（注意：我们可能还会使用 googlemaps Python 包 ，但使用它需要获取 API 密钥）。</p>
<p>In [12]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_distances</span><span class="params">(stations=stations)</span>:</span></span><br><span class="line">    <span class="string">"""Query the Google API for bicycling distances"""</span></span><br><span class="line">    latlon_list = [<span class="string">'&#123;0&#125;,&#123;1&#125;'</span>.format(lat, long)</span><br><span class="line">                   <span class="keyword">for</span> (lat, long) <span class="keyword">in</span> zip(stations.lat, stations.long)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_url</span><span class="params">(i)</span>:</span></span><br><span class="line">        URL = (<span class="string">'https://maps.googleapis.com/maps/api/distancematrix/json?'</span></span><br><span class="line">               <span class="string">'origins=&#123;origins&#125;&amp;destinations=&#123;destinations&#125;&amp;mode=bicycling'</span>)</span><br><span class="line">        <span class="keyword">return</span> URL.format(origins=latlon_list[i],</span><br><span class="line">                          destinations=<span class="string">'|'</span>.join(latlon_list[i + <span class="number">1</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(latlon_list) - <span class="number">1</span>):</span><br><span class="line">        url = create_url(i)</span><br><span class="line">        filename = <span class="string">"distances_&#123;0&#125;.json"</span>.format(stations.terminal.iloc[i])</span><br><span class="line">        print(i, filename)</span><br><span class="line">        !curl <span class="string">"&#123;url&#125;"</span> -o &#123;filename&#125;</span><br><span class="line">        sleep(<span class="number">11</span>) <span class="comment"># only one query per 10 seconds!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_distance_matrix</span><span class="params">(stations=stations)</span>:</span></span><br><span class="line">    <span class="string">"""Build a matrix from the Google API results"""</span></span><br><span class="line">    dist = np.zeros((len(stations), len(stations)), dtype=float)</span><br><span class="line">    <span class="keyword">for</span> i, term <span class="keyword">in</span> enumerate(stations.terminal[:<span class="number">-1</span>]):</span><br><span class="line">        filename = <span class="string">'queried_distances/distances_&#123;0&#125;.json'</span>.format(term)</span><br><span class="line">        row = json.load(open(filename))</span><br><span class="line">        dist[i, i + <span class="number">1</span>:] = [el[<span class="string">'distance'</span>][<span class="string">'value'</span>] <span class="keyword">for</span> el <span class="keyword">in</span> row[<span class="string">'rows'</span>][<span class="number">0</span>][<span class="string">'elements'</span>]]</span><br><span class="line">    dist += dist.T</span><br><span class="line">    distances = pd.DataFrame(dist, index=stations.terminal,</span><br><span class="line">                             columns=stations.terminal)</span><br><span class="line">    distances.to_csv(<span class="string">'station_distances.csv'</span>)</span><br><span class="line">    <span class="keyword">return</span> distances</span><br><span class="line"></span><br><span class="line"><span class="comment"># only call this the first time</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'station_distances.csv'</span>):</span><br><span class="line">    <span class="comment"># Note: you can call this function at most ~twice per day!</span></span><br><span class="line">    query_distances()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Move all the queried files into a directory</span></span><br><span class="line">    <span class="comment"># so we don't accidentally overwrite them</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'queried_distances'</span>):</span><br><span class="line">        os.makedirs(<span class="string">'queried_distances'</span>)</span><br><span class="line">    !mv distances_*.json queried_distances</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Build distance matrix and save to CSV</span></span><br><span class="line">    distances = build_distance_matrix()</span><br></pre></td></tr></table></figure>

<p>这里是第一个 5x5 距离矩阵：</p>
<p>In [13]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">distances = pd.read_csv(<span class="string">'station_distances.csv'</span>, index_col=<span class="string">'terminal'</span>)</span><br><span class="line">distances.iloc[:<span class="number">5</span>, :<span class="number">5</span>]</span><br></pre></td></tr></table></figure>

<p>Out[13]:</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BT-01</th>
      <th>BT-03</th>
      <th>BT-04</th>
      <th>BT-05</th>
      <th>CBD-13</th>
    </tr>
    <tr>
      <th>terminal</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BT-01</th>
      <td>0</td>
      <td>422</td>
      <td>1067</td>
      <td>867</td>
      <td>1342</td>
    </tr>
    <tr>
      <th>BT-03</th>
      <td>422</td>
      <td>0</td>
      <td>838</td>
      <td>445</td>
      <td>920</td>
    </tr>
    <tr>
      <th>BT-04</th>
      <td>1067</td>
      <td>838</td>
      <td>0</td>
      <td>1094</td>
      <td>1121</td>
    </tr>
    <tr>
      <th>BT-05</th>
      <td>867</td>
      <td>445</td>
      <td>1094</td>
      <td>0</td>
      <td>475</td>
    </tr>
    <tr>
      <th>CBD-13</th>
      <td>1342</td>
      <td>920</td>
      <td>1121</td>
      <td>475</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<p>让我们将这些距离转换为英里，并将它们加入我们的行程数据：</p>
<p>In [14]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stacked = distances.stack() / <span class="number">1609.34</span>  <span class="comment"># convert meters to miles</span></span><br><span class="line">stacked.name = <span class="string">'distance'</span></span><br><span class="line">trips = trips.join(stacked, on=[<span class="string">'from_station_id'</span>,<span class="string">'to_station_id'</span>])</span><br></pre></td></tr></table></figure>

<p>现在我们可以绘制行程距离的分布：</p>
<p>In [15]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fig, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">4</span>))</span><br><span class="line">trips.groupby(<span class="string">'usertype'</span>)[<span class="string">'distance'</span>].hist(bins=np.linspace(<span class="number">0</span>, <span class="number">6.99</span>, <span class="number">50</span>),</span><br><span class="line">                                           alpha=<span class="number">0.5</span>, ax=ax);</span><br><span class="line">plt.xlabel(<span class="string">'Distance between start &amp; end (miles)'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'relative frequency'</span>)</span><br><span class="line">plt.title(<span class="string">'Minimum Distance of Trip'</span>)</span><br><span class="line">plt.legend([<span class="string">'Annual Members'</span>, <span class="string">'Short-term Pass'</span>]);</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvuk9mwpzj20ke07tjrm" alt></p>
<p>请记住，这显示站点之间的最短可能距离，是每次行程上实际距离的下限。许多旅行（特别是临时用户）在几个街区内开始和结束。除此之外，旅行高峰一般在大约 1 英里左右，也有一些用户将他们的旅行距离扩展到四英里或更长的距离。</p>
<h2 id="骑手速度"><a href="#骑手速度" class="headerlink" title="骑手速度"></a>骑手速度</h2><p>给定这些距离，我们还可以计算估计骑行速度的下限。 让我们这样做，然后看看年费用户和临时用户的速度分布：</p>
<p>In [16]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">trips[<span class="string">'speed'</span>] = trips.distance * <span class="number">60</span> / trips.minutes</span><br><span class="line">trips.groupby(<span class="string">'usertype'</span>)[<span class="string">'speed'</span>].hist(bins=np.linspace(<span class="number">0</span>, <span class="number">15</span>, <span class="number">50</span>), alpha=<span class="number">0.5</span>, normed=<span class="literal">True</span>);</span><br><span class="line">plt.xlabel(<span class="string">'lower bound riding speed (MPH)'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'relative frequency'</span>)</span><br><span class="line">plt.title(<span class="string">'Rider Speed Lower Bound (MPH)'</span>)</span><br><span class="line">plt.legend([<span class="string">'Annual Members'</span>, <span class="string">'Short-term Pass'</span>]);</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvuq6y9e5j20dw0a5dg1" alt></p>
<p>有趣的是，分布是完全不同的，年费用户的速度平均值更高一些。你可能会想到这里的结论，年费用户的速度比临时用户更高，但数据本身不足以支持这一结论。如果年费用户倾向于通过最直接的路线从点 A 去往点 B，那么这些数据也可以被解释，而临时用户倾向于绕行并间接到达他们的目的地。我怀疑现实是这两种效应的混合。</p>
<p>还要看看距离和速度之间的关系：</p>
<p>In [17]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">g = sns.FacetGrid(trips, col=<span class="string">"usertype"</span>, hue=<span class="string">'usertype'</span>, size=<span class="number">6</span>)</span><br><span class="line">g.map(plt.scatter,<span class="string">"distance"</span>,<span class="string">"speed"</span>, s=<span class="number">4</span>, alpha=<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add lines and labels</span></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_ylabel(<span class="string">'Lower Bound Speed'</span>)</span><br><span class="line"><span class="keyword">for</span> ax <span class="keyword">in</span> g.axes.flat:</span><br><span class="line">    ax.set_xlabel(<span class="string">'Lower Bound Distance'</span>)</span><br><span class="line">    ax.plot(x, <span class="number">2</span> * x,<span class="string">'--r'</span>, alpha=<span class="number">0.3</span>)</span><br><span class="line">    ax.text(<span class="number">9.8</span>, <span class="number">16.5</span>,<span class="string">"Free Trips\n\nAdditional Fee"</span>, ha=<span class="string">'right'</span>,</span><br><span class="line">            size=<span class="number">18</span>, rotation=<span class="number">39</span>, alpha=<span class="number">0.5</span>, color=<span class="string">'red'</span>)</span><br><span class="line">    ax.axis([<span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">25</span>])</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvut21qj5j20no0butca" alt></p>
<p>总的来说，我们看到较长的路途速度更快 - 虽然这受到与上述相同的下限影响。如上所述，作为参考，我绘制了需要的红线用于区分额外费用（低于红线）和免费费用（红线以上）。我们再次看到，年度会员对于不超过半小时的限制比每天通过用户更加精明 - 点的分布的指向了用户注意了他们使用的时间，以避免额外的费用。</p>
<h2 id="海拔高度"><a href="#海拔高度" class="headerlink" title="海拔高度"></a>海拔高度</h2><p>在西雅图自行车分享服务的可行性的一个焦点是，西雅图是一个丘陵城市。在服务发布之前，一些分析师预测，西雅图会有源源不断的自行车上坡下坡，所以并不适合分享单车系统的落地。</p>
<p>数据版本中不包含海拔高度数据，但我们可以转到 Google Maps API 获取我们需要的数据; 请参阅 <a href="https://developers.google.com/maps/documentation/elevation/intro" target="_blank" rel="noopener">此网站</a> 了解海拔 API 的描述。</p>
<p>在这种情况下，自由使用限制为每天 2500 个请求，每次请求最多包含 512 个海拔高度。 由于我们只需要 55 个海拔高度，我们可以在单个查询中执行：</p>
<p>In [18]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_station_elevations</span><span class="params">(stations)</span>:</span></span><br><span class="line">    <span class="string">"""Get station elevations via Google Maps API"""</span></span><br><span class="line">    URL = <span class="string">"https://maps.googleapis.com/maps/api/elevation/json?locations="</span></span><br><span class="line">    locs = <span class="string">'|'</span>.join([<span class="string">'&#123;0&#125;,&#123;1&#125;'</span>.format(lat, long)</span><br><span class="line">                     <span class="keyword">for</span> (lat, long) <span class="keyword">in</span> zip(stations.lat, stations.long)])</span><br><span class="line">    URL += locs</span><br><span class="line">    !curl <span class="string">"&#123;URL&#125;"</span> -o elevations.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_station_elevations</span><span class="params">()</span>:</span><span class="string">"""Convert Elevations JSON output to CSV"""</span></span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line">    D = json.load(open(<span class="string">'elevations.json'</span>))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unnest</span><span class="params">(D)</span>:</span></span><br><span class="line">        loc = D.pop(<span class="string">'location'</span>)</span><br><span class="line">        loc.update(D)</span><br><span class="line">        <span class="keyword">return</span> loc</span><br><span class="line">    elevs = pd.DataFrame([unnest(item) <span class="keyword">for</span> item <span class="keyword">in</span> D[<span class="string">'results'</span>]])</span><br><span class="line">    elevs.to_csv(<span class="string">'station_elevations.csv'</span>)</span><br><span class="line">    <span class="keyword">return</span> elevs</span><br><span class="line"></span><br><span class="line"><span class="comment"># only run this the first time:</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">'station_elevations.csv'</span>):</span><br><span class="line">    get_station_elevations(stations)</span><br><span class="line">    process_station_elevations()</span><br></pre></td></tr></table></figure>

<p>现在让我们读入海拔高度数据：</p>
<p>In [19]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elevs = pd.read_csv(<span class="string">'station_elevations.csv'</span>, index_col=<span class="number">0</span>)</span><br><span class="line">elevs.head()</span><br></pre></td></tr></table></figure>

<p>Out[19]:</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>elevation</th>
      <th>lat</th>
      <th>lng</th>
      <th>resolution</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>37.351780</td>
      <td>47.618418</td>
      <td>-122.350964</td>
      <td>76.351616</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33.815830</td>
      <td>47.615829</td>
      <td>-122.348564</td>
      <td>76.351616</td>
    </tr>
    <tr>
      <th>2</th>
      <td>34.274055</td>
      <td>47.616094</td>
      <td>-122.341102</td>
      <td>76.351616</td>
    </tr>
    <tr>
      <th>3</th>
      <td>44.283257</td>
      <td>47.613110</td>
      <td>-122.344208</td>
      <td>76.351616</td>
    </tr>
    <tr>
      <th>4</th>
      <td>42.460381</td>
      <td>47.610185</td>
      <td>-122.339641</td>
      <td>76.351616</td>
    </tr>
  </tbody>
</table>

<p>为了验证结果，我们需要仔细检查纬度和经度是否匹配：</p>
<p>In [20]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># double check that locations match</span></span><br><span class="line">print(np.allclose(stations.long, elevs.lng))</span><br><span class="line">print(np.allclose(stations.lat, elevs.lat))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">True</span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<p>现在我们可以将海拔数据与行程数据整合：</p>
<p>In [21]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stations[<span class="string">'elevation'</span>] = elevs[<span class="string">'elevation'</span>]</span><br><span class="line">elevs.index = stations[<span class="string">'terminal'</span>]</span><br><span class="line"></span><br><span class="line">trips[<span class="string">'elevation_start'</span>] = trips.join(elevs, on=<span class="string">'from_station_id'</span>)[<span class="string">'elevation'</span>]</span><br><span class="line">trips[<span class="string">'elevation_end'</span>] = trips.join(elevs, on=<span class="string">'to_station_id'</span>)[<span class="string">'elevation'</span>]</span><br><span class="line">trips[<span class="string">'elevation_gain'</span>] = trips[<span class="string">'elevation_end'</span>] - trips[<span class="string">'elevation_start'</span>]</span><br></pre></td></tr></table></figure>

<p>让我们来看看海拔数据和会员类型的分布关系：</p>
<p>In [22]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">g = sns.FacetGrid(trips, col=<span class="string">"usertype"</span>, hue=<span class="string">'usertype'</span>)</span><br><span class="line">g.map(plt.hist,<span class="string">"elevation_gain"</span>, bins=np.arange(<span class="number">-145</span>, <span class="number">150</span>, <span class="number">10</span>))</span><br><span class="line">g.fig.set_figheight(<span class="number">6</span>)</span><br><span class="line">g.fig.set_figwidth(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># plot some lines to guide the eye</span></span><br><span class="line"><span class="keyword">for</span> lim <span class="keyword">in</span> range(<span class="number">60</span>, <span class="number">150</span>, <span class="number">20</span>):</span><br><span class="line">    x = np.linspace(-lim, lim, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">for</span> ax <span class="keyword">in</span> g.axes.flat:</span><br><span class="line">        ax.fill(x, <span class="number">100</span> * (lim - abs(x)),</span><br><span class="line">                color=<span class="string">'gray'</span>, alpha=<span class="number">0.1</span>, zorder=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvwev74fzj20su0a2mxj" alt></p>
<p>我们在背景中绘制了一些阴影以帮助引导分析。 年度会员和临时用户之间有很大的区别：年费用户非常明显的表示出偏好下坡行程（左侧的分布），而临时用户表现并不明显，而是表示喜欢骑乘开始并在相同高度结束。</p>
<p>为了使海拔数据变化的影响更加明显，我们做一些计算：</p>
<p>In [23]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"total downhill trips:"</span>, (trips.elevation_gain &lt; <span class="number">0</span>).sum())</span><br><span class="line">print(<span class="string">"total uphill trips:"</span>, (trips.elevation_gain&gt; <span class="number">0</span>).sum())</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">total downhill trips: 80532</span><br><span class="line">total uphill trips:   50493</span><br></pre></td></tr></table></figure>

<p>我们看到，第一年下坡比上坡多出了 3 万次 - 这是大约 60％ 以上。 根据目前的使用水平，这意味着 Pronto 工作人员必须每天从海拔较低的服务点运送大约 100 辆自行车到高海拔服务点。</p>
<h2 id="天气"><a href="#天气" class="headerlink" title="天气"></a>天气</h2><p>另一个常见的反对循环共享的可行性的论点是天气。让我们来看看出行数量随着温度和降水量的变化。</p>
<p>幸运的是，数据包括了大范围的天气数据：</p>
<p>In [24]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">weather = pd.read_csv(<span class="string">'2015_weather_data.csv'</span>, index_col=<span class="string">'Date'</span>, parse_dates=<span class="literal">True</span>)</span><br><span class="line">weather.columns</span><br></pre></td></tr></table></figure>

<p>Out[24]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Index([<span class="string">'Max_Temperature_F'</span>, <span class="string">'Mean_Temperature_F'</span>, <span class="string">'Min_TemperatureF'</span>,</span><br><span class="line">       <span class="string">'Max_Dew_Point_F'</span>, <span class="string">'MeanDew_Point_F'</span>, <span class="string">'Min_Dewpoint_F'</span>, <span class="string">'Max_Humidity'</span>,</span><br><span class="line">       <span class="string">'Mean_Humidity'</span>, <span class="string">'Min_Humidity'</span>, <span class="string">'Max_Sea_Level_Pressure_In'</span>,</span><br><span class="line">       <span class="string">'Mean_Sea_Level_Pressure_In'</span>, <span class="string">'Min_Sea_Level_Pressure_In'</span>,</span><br><span class="line">       <span class="string">'Max_Visibility_Miles'</span>, <span class="string">'Mean_Visibility_Miles'</span>,</span><br><span class="line">       <span class="string">'Min_Visibility_Miles'</span>, <span class="string">'Max_Wind_Speed_MPH'</span>, <span class="string">'Mean_Wind_Speed_MPH'</span>,</span><br><span class="line">       <span class="string">'Max_Gust_Speed_MPH'</span>, <span class="string">'Precipitation_In'</span>, <span class="string">'Events'</span>],</span><br><span class="line">      dtype=<span class="string">'object'</span>)</span><br><span class="line">       dtype =<span class="string">'object'</span>）</span><br></pre></td></tr></table></figure>

<p>让我们将天气数据与行程数据结合起来：</p>
<p>In [25]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">by_date = trips.groupby([<span class="string">'date'</span>, <span class="string">'usertype'</span>])[<span class="string">'trip_id'</span>].count()</span><br><span class="line">by_date.name = <span class="string">'count'</span></span><br><span class="line">by_date = by_date.reset_index(<span class="string">'usertype'</span>).join(weather)</span><br></pre></td></tr></table></figure>

<p>现在我们可以看看按工作日和周末为纬度，查看出行数量随温度和降水量的变化：</p>
<p>In [26]:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add a flag indicating weekend</span></span><br><span class="line">by_date[<span class="string">'weekend'</span>] = (by_date.index.dayofweek&gt;= <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Plot Temperature Trend</span></span><br><span class="line">g = sns.FacetGrid(by_date, col=<span class="string">"weekend"</span>, hue=<span class="string">'usertype'</span>, size=<span class="number">6</span>)</span><br><span class="line">g.map(sns.regplot,<span class="string">"Mean_Temperature_F"</span>,<span class="string">"count"</span>)</span><br><span class="line">g.add_legend();</span><br><span class="line"></span><br><span class="line"><span class="comment"># do some formatting</span></span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_title(<span class="string">''</span>)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].set_title(<span class="string">''</span>)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].text(<span class="number">0.05</span>, <span class="number">0.95</span>,<span class="string">'Monday - Friday'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</span><br><span class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">0</span>].transAxes)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].text(<span class="number">0.05</span>, <span class="number">0.95</span>,<span class="string">'Saturday - Sunday'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</span><br><span class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">1</span>].transAxes)</span><br><span class="line">g.fig.text(<span class="number">0.45</span>, <span class="number">1</span>,<span class="string">"Trend With Temperature"</span>, ha=<span class="string">'center'</span>, va=<span class="string">'top'</span>, size=<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Plot Precipitation</span></span><br><span class="line">g = sns.FacetGrid(by_date, col=<span class="string">"weekend"</span>, hue=<span class="string">'usertype'</span>, size=<span class="number">6</span>)</span><br><span class="line">g.map(sns.regplot,<span class="string">"Precipitation_In "</span>,<span class="string">"count"</span>)</span><br><span class="line">g.add_legend();</span><br><span class="line"></span><br><span class="line"><span class="comment"># do some formatting</span></span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_ylim(<span class="number">-50</span>, <span class="number">600</span>);</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].set_title(<span class="string">''</span>)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].set_title(<span class="string">''</span>)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">0</span>].text(<span class="number">0.95</span>, <span class="number">0.95</span>,<span class="string">'Monday - Friday'</span>, ha=<span class="string">'right'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</span><br><span class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">0</span>].transAxes)</span><br><span class="line">g.axes[<span class="number">0</span>, <span class="number">1</span>].text(<span class="number">0.95</span>, <span class="number">0.95</span>,<span class="string">'Saturday - Sunday'</span>, ha=<span class="string">'right'</span>, va=<span class="string">'top'</span>, size=<span class="number">14</span>,</span><br><span class="line">                  transform=g.axes[<span class="number">0</span>, <span class="number">1</span>].transAxes)</span><br><span class="line">g.fig.text(<span class="number">0.45</span>, <span class="number">1</span>,<span class="string">"Trend With Precipitation"</span>, ha=<span class="string">'center'</span>, va=<span class="string">'top'</span>, size=<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvwqa1v43j20rp0c4wg6" alt><br>   <img src="http://ww1.sinaimg.cn/large/69e37fdbgy1fcvwqr99vcj20rj0c440e" alt></p>
<p>对于天气的影响，我们可以看出明显的趋势：人们更喜欢温暖、阳光明媚的天气。但是也有一些有趣的细节：工作日期间，所有的用户都受到天气的影响。然而周末年费用户受影响更少。我没有什么好的理论说明为什么有这种趋势，如果你有好的想法，欢迎提供。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据上面的一些系列分析，但是我想我们可以从这些数据中获得一些结论：</p>
<ul>
<li>年费用户与临时用户整体上会有不同的行为：年费用户通常是利用 Pronto 进行工作日的通勤。临时用户则是周末使用 Pronto 探索城市的特定区域。</li>
<li>尽管年费用户对定价策略有所了解，但是四分之一的行程还是超过了半小时的限制，并产生了额外的费用。为了客户的权益，Pronto 应该更好告知用户这种定价策略。</li>
<li>海拔和天气会影响使用，正如你预计的一样：下坡比上坡多 60%，寒冷和下雨也会明显减少当天的骑行数量。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.4async.com/2017/02/2017-02-08-more-effective-golang-error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
      <meta itemprop="name" content="ipfans">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ipfans's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/2017-02-08-more-effective-golang-error/" class="post-title-link" itemprop="url">更优雅的 Golang 错误处理</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-02-08 18:00:00" itemprop="dateCreated datePublished" datetime="2017-02-08T18:00:00+08:00">2017-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-07-04 11:20:39" itemprop="dateModified" datetime="2019-07-04T11:20:39+08:00">2019-07-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2017/02/2017-02-08-more-effective-golang-error/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/02/2017-02-08-more-effective-golang-error/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Golang 中的错误处理是一个被大家经常拿出来讨论的 <a href="http://www.infoq.com/cn/news/2012/11/go-error-handle" target="_blank" rel="noopener">话题</a>(另外一个是 <a href="http://www.weibo.com/1609119537/CdzJVejwg?type=comment" target="_blank" rel="noopener">泛型</a>)。其中泛型这个问题，rsc 在最近的计划中也<a href="https://mp.weixin.qq.com/s?__biz=MjM5OTcxMzE0MQ==&mid=2653369836&idx=1&sn=ddff3df7dbf52bb5bcc8b0ace78e0121&chksm=bce4d5f68b935ce0ece41ada8a49bbd33b638d184901ca8a61b5288daaf7c5a2d63af0cc3b34" target="_blank" rel="noopener">提出</a> 了纳入他今年的考虑计划中，同时，<a href="https://github.com/golang/proposal/blob/master/design/15292-generics.md" target="_blank" rel="noopener">泛型的提案</a> 在 2016 年也进行了一些更新，相信未来会有一些更好的方案提出。这个文章我们讨论一下如何在现行的 Golang 框架下提供更友好和优雅的错误处理。</p>
<h2 id="从现状谈起"><a href="#从现状谈起" class="headerlink" title="从现状谈起"></a>从现状谈起</h2><p>Golang 中的错误处理原则，开发者曾经之前专门发布了几篇文章 (<a href="https://blog.golang.org/error-handling-and-go" target="_blank" rel="noopener">Error handling and Go</a> 和 <a href="https://blog.golang.org/defer-panic-and-recover" target="_blank" rel="noopener">Defer, Panic, and Recover</a>、<a href="https://blog.golang.org/errors-are-values" target="_blank" rel="noopener">Errors are values</a> ) 介绍。分别介绍了 Golang 中处理一般预知到的错误与遇到崩溃时的错误处理机制。</p>
<p>一般情况下，我们还是以官方博客中的错误处理例子为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;f, err := os.Open(<span class="string">"filename.ext"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;log.Fatal(err)</span><br><span class="line">        <span class="comment">// 或者更简单的：</span></span><br><span class="line">        <span class="comment">// return err</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然对于简化代码行数，还有另外一种写法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">if</span> f, err = os.Open(<span class="string">"filename.ext"</span>); err != <span class="literal">nil</span>&#123;log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正常情况下，Golang 现有的哲学中，要求你尽量手工处理所有的错误返回，这稍微增加了开发人员的心智负担。关于这部分设计的讨论，请参考本文最开始提供的参考链接，此处不做太多探讨。</p>
<p>本质上，Golang 中的错误类型 <code>error</code> 是一个接口类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type error interface &#123;Error() string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要满足这一接口定义的所有数值都可以传入 <code>error</code> 类型的位置。在 <a href="http://go-proverbs.github.io/" target="_blank" rel="noopener">Go Proverbs</a> 中也提到了关于错误的描述： <figure class="highlight plain"><figcaption><span>are values```。这一句如何理解呢？</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Errors are values</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">事实上，在实际使用过程中，你可能也发现了对 Golang 而言，所有的信息是非常不足的。比如下面这个例子：</span><br><span class="line"></span><br><span class="line">```go</span><br><span class="line">buf := make([]byte, 100)</span><br><span class="line">n, err := r.Read(buf)</span><br><span class="line">buf = buf[:n]</span><br><span class="line">if err == io.EOF &#123;log.Fatal(&quot;read failed:&quot;, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>事实上这只会打印信息 <code>2017/02/08 13:53:54 read failed:EOF</code>，这对我们真实环境下的错误调试与分析其实是并没有任何意义的，我们在查看日志获取错误信息的时候能够获取到的信息十分有限。</p>
<p>于是乎，一些提供了上下文方式的一些错误处理形式便在很多类库中非常常见：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">err := os.Remove(<span class="string">"/tmp/nonexist"</span>)</span><br><span class="line">log.Println(err)</span><br></pre></td></tr></table></figure>

<p>输出了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2017/02/08 14:09:22 remove /tmp/nonexist: no such file or directory</span><br></pre></td></tr></table></figure>

<p>这种方式提供了一种更加直观的上下文信息，比如具体出错的内容，也可以是出现错误的文件等等。通过查看 Remove 的实现，我们可以看到：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PathError records an error and the operation and file path that caused it.</span></span><br><span class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;</span><br><span class="line">	Op   <span class="keyword">string</span></span><br><span class="line">	Path <span class="keyword">string</span></span><br><span class="line">	Err  error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PathError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> e.Op +<span class="string">" "</span>+ e.Path +<span class="string">": "</span>+ e.Err.Error() &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file_unix.go 针对 *nix 系统的实现</span></span><br><span class="line"><span class="comment">// Remove removes the named file or directory.</span></span><br><span class="line"><span class="comment">// If there is an error, it will be of type *PathError.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Remove</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// System call interface forces us to know</span></span><br><span class="line">	<span class="comment">// whether name is a file or directory.</span></span><br><span class="line">	<span class="comment">// Try both: it is cheaper on average than</span></span><br><span class="line">	<span class="comment">// doing a Stat plus the right one.</span></span><br><span class="line">	e := syscall.Unlink(name)</span><br><span class="line">	<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">	e1 := syscall.Rmdir(name)</span><br><span class="line">	<span class="keyword">if</span> e1 == <span class="literal">nil</span> &#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Both failed: figure out which error to return.</span></span><br><span class="line">	<span class="comment">// OS X and Linux differ on whether unlink(dir)</span></span><br><span class="line">	<span class="comment">// returns EISDIR, so can't use that. However,</span></span><br><span class="line">	<span class="comment">// both agree that rmdir(file) returns ENOTDIR,</span></span><br><span class="line">	<span class="comment">// so we can use that to decide which error is real.</span></span><br><span class="line">	<span class="comment">// Rmdir might also return ENOTDIR if given a bad</span></span><br><span class="line">	<span class="comment">// file path, like /etc/passwd/foo, but in that case,</span></span><br><span class="line">	<span class="comment">// both errors will be ENOTDIR, so it's okay to</span></span><br><span class="line">	<span class="comment">// use the error from unlink.</span></span><br><span class="line">	<span class="keyword">if</span> e1 != syscall.ENOTDIR &#123;e = e1&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;PathError&#123;<span class="string">"remove"</span>, name, e&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上这里 Golang 标准库中返回了一个名为 <code>PathError</code> 的结构体，这个结构体定义了操作类型、路径和原始的错误信息，然后通过 <code>Error</code> 方法对所有信息进行了整合。</p>
<p>但是这样也会存在问题，比如需要进行单独类型复杂的分类处理，比如上面例子中，需要单独处理 <code>PathError</code> 这种问题，你可能需要一个单独的类型推导：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">err := xxxx()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;swtich err := err.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> *os.PathError:</span><br><span class="line">		...</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样反倒会增加错误处理的复杂度。同时，这些错误必须变为导出类型，也会增加整个系统的复杂度。</p>
<p>另外一个问题是，我们在出现错误时，我们通常也希望获取更多的堆栈信息，方便我们进行后续的故障追踪。在现有的错误体系中，这相对比较复杂：你很难通过一个接口类型获取完整的调用堆栈。这时，我们可能就需要一个第三方库区去解决遇到的这些错误处理问题。</p>
<p>还有一种情况是，我们希望在错误处理过程中同样可以附加一些信息，这些也会相对比较麻烦。</p>
<h2 id="更优雅的错误处理"><a href="#更优雅的错误处理" class="headerlink" title="更优雅的错误处理"></a>更优雅的错误处理</h2><p>之前提到了多种实际应用场景中出现的错误处理方法和遇到的一些问题，这里推荐使用第三方库去解决部分问题：<code>github.com/pkg/errors</code>。</p>
<p>比如当我们出现问题时，我们可以简单的使用 <code>errors.New</code> 或者 <code>errors.Errorf</code> 生成一个错误变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">err := errors.New(<span class="string">"whoops"</span>)</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">err := errors.Errorf(<span class="string">"whoops: %s"</span>, <span class="string">"foo"</span>)</span><br></pre></td></tr></table></figure>

<p>当我们需要附加信息时，则可以使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cause := errors.New(<span class="string">"whoops"</span>)</span><br><span class="line">err := errors.Wrap(cause,<span class="string">"oh noes"</span>)</span><br></pre></td></tr></table></figure>

<p>当需要获取 @用堆栈时，则可以使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">err := errors.New(<span class="string">"whoops"</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%+v"</span>, err)</span><br></pre></td></tr></table></figure>

<h2 id="其他建议"><a href="#其他建议" class="headerlink" title="其他建议"></a>其他建议</h2><p>在上面做类型推导时，我们发现在处理一类错误时可能需要多个错误类型，这可能在某些情况下相对来说比较复杂，很多时候我们可以使用接口形式去方便处理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> temporary <span class="keyword">interface</span> &#123;Temporary() <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IsTemporary returns true if err is temporary.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsTemporary</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;te, ok := errors.Cause(err).(temporary)</span><br><span class="line">	<span class="keyword">return</span> ok &amp;&amp; te.Temporary()&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以提供更加方便的错误解析和处理。</p>
<h3 id="广告时间"><a href="#广告时间" class="headerlink" title="广告时间"></a>广告时间</h3><p>我们正在招收新人 Gopher，应届毕业生 or 实习生欢迎投递简历。我们正在努力实现开发流程标准化，如果你想获得提高，相信也是一个非常不错的机会。简历投递 kevin [at] yeeuu [dot] com。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ipfans"
      src="https://avatars0.githubusercontent.com/u/363344?v=3&s=460">
  <p class="site-author-name" itemprop="name">ipfans</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">80</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ipfans" title="GitHub → https://github.com/ipfans" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/janxin" title="Twitter → https://twitter.com/janxin" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2013 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ipfans</span>
</div>

        








        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://s1mbily.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

  <script>
  var link = "" ;
  // 遍历所有的img标签
  $("img").each( (i,o) => {
    var o = $(o);
      // 判断图片的链接是否包含sinaimg关键字
    if( o.attr("src").indexOf("sinaimg") > 0 ){
          // 给这个标签加上referrerPlicy属性
      o.attr("referrerpolicy","no-referrer");
          // 备份图片的src
      link = o.attr("src");
          // 重新设置src，让页面重新加载一次图片
      o.attr("src",link);
    }
  });
  </script>
</body>
</html>
