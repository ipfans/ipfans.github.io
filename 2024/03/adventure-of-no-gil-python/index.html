<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='在前几周的时候，Python的允许禁用 GIL PR 正式合并进入了 Python 3.13 的master分支。这是一个非常重要的 PR，因为它在未来将会对 Python 的并发性能产生非常大的影响。在即将到来的 Python 3.13 中，这个允许禁用 GIL和包含了 Copy and Paste JIT 技术，这些同时都对 Python 的性能产生了非常大的影响。
什么是 GIL GIL，即全局解释器锁，是 Python 语言中一个技术术语。官方实现的 CPython 中包含了 GIL 的实现，同时也是最广泛使用的实现。GIL 的主要目的是在任何时候只允许一个线程执行 Python 字节码，这意味着即使你的程序在多核处理器上运行，也无法实现真正的并行执行。GIL 的存在主要是为了简化 CPython 的内存管理。Python 的对象，如列表、字典等，不是线程安全的，这意味着如果多个线程同时从不同的核心修改同一个对象，可能会导致数据不一致或者程序崩溃。GIL 通过限制同时执行的线程数来避免这种情况。
换句话说：如果一个系统线程想要执行 Python 的字节码，必须要获取到 GIL 锁，然后才可以执行 Python 字节码。而如果没有获取到锁，那么线程就会休眠，直到获得信号而被唤醒。为了保证 Python 的效率，Python 也会自动切换线程，比如 IO 阻塞时，或者执行了指定数量的 Python 字节码时。这样就尽量保证了 Python 的效率。当然，你也可以选择手工释放 GIL 锁，比如使用 C/C++/Rust 扩展，或者使用 Cython 等开发高性能扩展时。
但是这个 GIL 也是 Python 的一个瓶颈，因为它限制了 Python 的并发性能。在多核处理器上，Python 的并发性能并不是很好。这也是为什么很多人选择使用多进程而不是多线程来提高 Python 的并发性能。在现代的计算机上，多核处理器已经是标配，因此 Python 的并发性能成为了一个非常重要的问题。这也是为什么这么多年来，Python 的 GIL 一直是一个非常热门的话题。'><title>No GIL Python 的冒险</title>
<link rel=canonical href=https://www.4async.com/2024/03/adventure-of-no-gil-python/><link rel=stylesheet href=../../../scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property='og:title' content='No GIL Python 的冒险'><meta property='og:description' content='在前几周的时候，Python的允许禁用 GIL PR 正式合并进入了 Python 3.13 的master分支。这是一个非常重要的 PR，因为它在未来将会对 Python 的并发性能产生非常大的影响。在即将到来的 Python 3.13 中，这个允许禁用 GIL和包含了 Copy and Paste JIT 技术，这些同时都对 Python 的性能产生了非常大的影响。
什么是 GIL GIL，即全局解释器锁，是 Python 语言中一个技术术语。官方实现的 CPython 中包含了 GIL 的实现，同时也是最广泛使用的实现。GIL 的主要目的是在任何时候只允许一个线程执行 Python 字节码，这意味着即使你的程序在多核处理器上运行，也无法实现真正的并行执行。GIL 的存在主要是为了简化 CPython 的内存管理。Python 的对象，如列表、字典等，不是线程安全的，这意味着如果多个线程同时从不同的核心修改同一个对象，可能会导致数据不一致或者程序崩溃。GIL 通过限制同时执行的线程数来避免这种情况。
换句话说：如果一个系统线程想要执行 Python 的字节码，必须要获取到 GIL 锁，然后才可以执行 Python 字节码。而如果没有获取到锁，那么线程就会休眠，直到获得信号而被唤醒。为了保证 Python 的效率，Python 也会自动切换线程，比如 IO 阻塞时，或者执行了指定数量的 Python 字节码时。这样就尽量保证了 Python 的效率。当然，你也可以选择手工释放 GIL 锁，比如使用 C/C++/Rust 扩展，或者使用 Cython 等开发高性能扩展时。
但是这个 GIL 也是 Python 的一个瓶颈，因为它限制了 Python 的并发性能。在多核处理器上，Python 的并发性能并不是很好。这也是为什么很多人选择使用多进程而不是多线程来提高 Python 的并发性能。在现代的计算机上，多核处理器已经是标配，因此 Python 的并发性能成为了一个非常重要的问题。这也是为什么这么多年来，Python 的 GIL 一直是一个非常热门的话题。'><meta property='og:url' content='https://www.4async.com/2024/03/adventure-of-no-gil-python/'><meta property='og:site_name' content="ipfans's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='no-gil'><meta property='article:tag' content='Python'><meta property='article:published_time' content='2024-03-18T10:11:00+00:00'><meta property='article:modified_time' content='2024-03-18T10:11:00+00:00'><meta property='og:image' content='https://www.4async.com/2024/03/adventure-of-no-gil-python/cover.png'><meta name=twitter:site content="@janxin"><meta name=twitter:creator content="@janxin"><meta name=twitter:title content="No GIL Python 的冒险"><meta name=twitter:description content="在前几周的时候，Python的允许禁用 GIL PR 正式合并进入了 Python 3.13 的master分支。这是一个非常重要的 PR，因为它在未来将会对 Python 的并发性能产生非常大的影响。在即将到来的 Python 3.13 中，这个允许禁用 GIL和包含了 Copy and Paste JIT 技术，这些同时都对 Python 的性能产生了非常大的影响。
什么是 GIL GIL，即全局解释器锁，是 Python 语言中一个技术术语。官方实现的 CPython 中包含了 GIL 的实现，同时也是最广泛使用的实现。GIL 的主要目的是在任何时候只允许一个线程执行 Python 字节码，这意味着即使你的程序在多核处理器上运行，也无法实现真正的并行执行。GIL 的存在主要是为了简化 CPython 的内存管理。Python 的对象，如列表、字典等，不是线程安全的，这意味着如果多个线程同时从不同的核心修改同一个对象，可能会导致数据不一致或者程序崩溃。GIL 通过限制同时执行的线程数来避免这种情况。
换句话说：如果一个系统线程想要执行 Python 的字节码，必须要获取到 GIL 锁，然后才可以执行 Python 字节码。而如果没有获取到锁，那么线程就会休眠，直到获得信号而被唤醒。为了保证 Python 的效率，Python 也会自动切换线程，比如 IO 阻塞时，或者执行了指定数量的 Python 字节码时。这样就尽量保证了 Python 的效率。当然，你也可以选择手工释放 GIL 锁，比如使用 C/C++/Rust 扩展，或者使用 Cython 等开发高性能扩展时。
但是这个 GIL 也是 Python 的一个瓶颈，因为它限制了 Python 的并发性能。在多核处理器上，Python 的并发性能并不是很好。这也是为什么很多人选择使用多进程而不是多线程来提高 Python 的并发性能。在现代的计算机上，多核处理器已经是标配，因此 Python 的并发性能成为了一个非常重要的问题。这也是为什么这么多年来，Python 的 GIL 一直是一个非常热门的话题。"><meta name=twitter:card content="summary"><meta name=twitter:image content='https://www.4async.com/2024/03/adventure-of-no-gil-python/cover.png'><script async src="https://www.googletagmanager.com/gtag/js?id=G-G9H3Z8QND5"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G9H3Z8QND5",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=../../../><img src=../../../img/avatar_huae056372e08c63f80862e9295e80f934_12087_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=../../../>ipfans's Blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=../../../><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=../../../about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=../../../archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=../../../atom.xml><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
<span>Feed</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#什么是-gil>什么是 GIL</a></li><li><a href=#安装-python-313a5>安装 Python 3.13a5</a></li><li><a href=#测试-gil-禁用效果>测试 GIL 禁用效果</a></li><li><a href=#总结>总结</a></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=../../../2024/03/adventure-of-no-gil-python/><img src=../../../2024/03/adventure-of-no-gil-python/cover_hu290e1410dad06028e05bea566a74bad2_241115_800x0_resize_box_3.png srcset="../../../2024/03/adventure-of-no-gil-python/cover_hu290e1410dad06028e05bea566a74bad2_241115_800x0_resize_box_3.png 800w, ../../../2024/03/adventure-of-no-gil-python/cover_hu290e1410dad06028e05bea566a74bad2_241115_1600x0_resize_box_3.png 1600w" width=800 height=383 loading=lazy alt="Featured image of post No GIL Python 的冒险"></a></div><div class=article-details><header class=article-category><a href=../../../categories/python/>Python</a></header><div class=article-title-wrapper><h2 class=article-title><a href=../../../2024/03/adventure-of-no-gil-python/>No GIL Python 的冒险</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 18, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 3 分钟</time></div></footer></div></header><section class=article-content><p>在前几周的时候，Python的<a class=link href=https://github.com/python/cpython/pull/116338 target=_blank rel=noopener>允许禁用 GIL PR</a> 正式合并进入了 Python 3.13 的master分支。这是一个非常重要的 PR，因为它在未来将会对 Python 的并发性能产生非常大的影响。在即将到来的 Python 3.13 中，这个允许禁用 GIL和包含了 Copy and Paste JIT 技术，这些同时都对 Python 的性能产生了非常大的影响。</p><h2 id=什么是-gil>什么是 GIL</h2><p>GIL，即全局解释器锁，是 Python 语言中一个技术术语。官方实现的 CPython 中包含了 GIL 的实现，同时也是最广泛使用的实现。GIL 的主要目的是在任何时候只允许一个线程执行 Python 字节码，这意味着即使你的程序在多核处理器上运行，也无法实现真正的并行执行。GIL 的存在主要是为了简化 CPython 的内存管理。Python 的对象，如列表、字典等，不是线程安全的，这意味着如果多个线程同时从不同的核心修改同一个对象，可能会导致数据不一致或者程序崩溃。GIL 通过限制同时执行的线程数来避免这种情况。</p><p>换句话说：如果一个系统线程想要执行 Python 的字节码，必须要获取到 GIL 锁，然后才可以执行 Python 字节码。而如果没有获取到锁，那么线程就会休眠，直到获得信号而被唤醒。为了保证 Python 的效率，Python 也会自动切换线程，比如 IO 阻塞时，或者执行了指定数量的 Python 字节码时。这样就尽量保证了 Python 的效率。当然，你也可以选择手工释放 GIL 锁，比如使用 C/C++/Rust 扩展，或者使用 Cython 等开发高性能扩展时。</p><p>但是这个 GIL 也是 Python 的一个瓶颈，因为它限制了 Python 的并发性能。在多核处理器上，Python 的并发性能并不是很好。这也是为什么很多人选择使用多进程而不是多线程来提高 Python 的并发性能。在现代的计算机上，多核处理器已经是标配，因此 Python 的并发性能成为了一个非常重要的问题。这也是为什么这么多年来，Python 的 GIL 一直是一个非常热门的话题。</p><h2 id=安装-python-313a5>安装 Python 3.13a5</h2><p>在这篇文章中，我们将会使用 Python 3.13a5 来演示如何禁用 GIL。你可以在<a class=link href=https://www.python.org/downloads/release/python-3130a5/ target=_blank rel=noopener>这里</a>下载 Python 3.13a5 的安装包。当然你也可以通过 <a class=link href=https://github.com/pyenv/pyenv target=_blank rel=noopener><code>pyenv</code></a> 管理多版本的 Python 版本。下图就是演示如何使用 <code>pyenv</code> 安装 Python 3.13a5 的过程：</p><p><img src=../../../2024/03/adventure-of-no-gil-python/install-pre-release.png width=1582 height=458 srcset="../../../2024/03/adventure-of-no-gil-python/install-pre-release_hu688f51cbefe74b0a6b725d565198d6ba_38292_480x0_resize_box_3.png 480w, ../../../2024/03/adventure-of-no-gil-python/install-pre-release_hu688f51cbefe74b0a6b725d565198d6ba_38292_1024x0_resize_box_3.png 1024w" loading=lazy alt="pyenv install cpython 3.13a5" class=gallery-image data-flex-grow=345 data-flex-basis=828px></p><p>注意这里的参数 <code>--disable-gil</code>，这个参数就是用来开启禁用 GIL 的功能选项。</p><h2 id=测试-gil-禁用效果>测试 GIL 禁用效果</h2><p>由于 GIL 主要限制了 Python 的并发性能，因此我们可以通过测试并发性能来测试 GIL 禁用的效果。这里我们使用了一个简单的多线程测试程序来测试 GIL 禁用的效果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># gil_bench.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> concurrent.futures <span style=color:#f92672>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_primes</span>(max: int) <span style=color:#f92672>-&gt;</span> list[int]:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> max <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  primes <span style=color:#f92672>=</span> [<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>3</span>, max <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    is_prime <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>2</span>, int(math<span style=color:#f92672>.</span>sqrt(n)) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> n <span style=color:#f92672>%</span> i <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        is_prime <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> is_prime:
</span></span><span style=display:flex><span>      primes<span style=color:#f92672>.</span>append(n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> primes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>  print(<span style=color:#e6db74>&#34;concurrency,time&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> concurrency <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    start <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>monotonic()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> ThreadPoolExecutor(max_workers<span style=color:#f92672>=</span>concurrency) <span style=color:#66d9ef>as</span> executor:
</span></span><span style=display:flex><span>      futures <span style=color:#f92672>=</span> [executor<span style=color:#f92672>.</span>submit(get_primes, <span style=color:#ae81ff>500000</span>) <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(concurrency)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> futures:
</span></span><span style=display:flex><span>      f<span style=color:#f92672>.</span>result()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    end <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>monotonic()
</span></span><span style=display:flex><span>    duration <span style=color:#f92672>=</span> end <span style=color:#f92672>-</span> start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>concurrency<span style=color:#e6db74>}</span><span style=color:#e6db74>,</span><span style=color:#e6db74>{</span>duration<span style=color:#e6db74>:</span><span style=color:#e6db74>.2f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></div><p>这个程序的主要功能是测试在不同的版本在线程池并发下，计算 500000 以内的素数所需要的时间。我们可以通过这个程序来测试 GIL 禁用的效果。</p><p>接下来我们可以尝试在不同版本的 Python 下执行这段代码的测试，作为对比，我们添加了多个 Python 版本进行对比：</p><blockquote><p>测试环境为 macOS 14.4 + M1 Pro 处理器</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ &gt; pyenv shell 3.10.13   <span style=color:#75715e># 使用 3.10.13 版本</span>
</span></span><span style=display:flex><span>$ &gt; python gil_bench.py 
</span></span><span style=display:flex><span>concurrency,time
</span></span><span style=display:flex><span>1,0.95
</span></span><span style=display:flex><span>2,1.90
</span></span><span style=display:flex><span>3,2.85
</span></span><span style=display:flex><span>4,3.81
</span></span><span style=display:flex><span>5,4.77
</span></span><span style=display:flex><span>6,5.73
</span></span><span style=display:flex><span>7,6.67
</span></span><span style=display:flex><span>8,7.64
</span></span><span style=display:flex><span>9,8.59
</span></span><span style=display:flex><span>10,9.55
</span></span><span style=display:flex><span>$ &gt; pyenv shell 3.12.2  <span style=color:#75715e># 使用 3.12.2 版本</span>
</span></span><span style=display:flex><span>$ &gt; python gil_bench.py
</span></span><span style=display:flex><span>concurrency,time
</span></span><span style=display:flex><span>1,0.88
</span></span><span style=display:flex><span>2,1.76
</span></span><span style=display:flex><span>3,2.64
</span></span><span style=display:flex><span>4,3.54
</span></span><span style=display:flex><span>5,4.44
</span></span><span style=display:flex><span>6,5.32
</span></span><span style=display:flex><span>7,6.21
</span></span><span style=display:flex><span>8,7.08
</span></span><span style=display:flex><span>9,7.98
</span></span><span style=display:flex><span>10,8.86
</span></span><span style=display:flex><span>$ &gt; pyenv shell 3.13.0a5  <span style=color:#75715e># 使用 3.13.0a5 版本，这个版本使用了 `--disable-gil` 参数编译</span>
</span></span><span style=display:flex><span>$ &gt; python gil_bench.py 
</span></span><span style=display:flex><span>concurrency,time
</span></span><span style=display:flex><span>1,1.01
</span></span><span style=display:flex><span>2,2.03
</span></span><span style=display:flex><span>3,3.04
</span></span><span style=display:flex><span>4,4.07
</span></span><span style=display:flex><span>5,5.11
</span></span><span style=display:flex><span>6,6.13
</span></span><span style=display:flex><span>7,7.17
</span></span><span style=display:flex><span>8,8.19
</span></span><span style=display:flex><span>9,9.17
</span></span><span style=display:flex><span>10,10.22
</span></span><span style=display:flex><span>$ &gt; python -X gil<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> gil_bench.py  <span style=color:#75715e># 使用 3.13.0a5 版本，这个版本使用了 `-X gil=0` 参数运行，这会禁用 GIL</span>
</span></span><span style=display:flex><span>concurrency,time
</span></span><span style=display:flex><span>1,1.01
</span></span><span style=display:flex><span>2,1.04
</span></span><span style=display:flex><span>3,1.25
</span></span><span style=display:flex><span>4,1.57
</span></span><span style=display:flex><span>5,1.61
</span></span><span style=display:flex><span>6,1.81
</span></span><span style=display:flex><span>7,2.28
</span></span><span style=display:flex><span>8,2.39
</span></span><span style=display:flex><span>9,2.75
</span></span><span style=display:flex><span>10,2.89
</span></span></code></pre></div><p>这个结果看上去还是有点乱，让我们整理成为表格：</p><div class=table-wrapper><table><thead><tr><th>并发数</th><th>Python 3.10.13</th><th>Python 3.12.2</th><th>Python 3.13.0a5 (&ndash;disable-gil)</th><th>Python 3.13.0a5 (&ndash;disable-gil) -X gil=0</th></tr></thead><tbody><tr><td>1</td><td>0.95</td><td><strong>0.88</strong></td><td>1.01</td><td>1.01</td></tr><tr><td>2</td><td>1.90</td><td>1.76</td><td>2.03</td><td><strong>1.04</strong></td></tr><tr><td>3</td><td>2.85</td><td>2.64</td><td>3.04</td><td><strong>1.25</strong></td></tr><tr><td>4</td><td>3.81</td><td>3.54</td><td>4.07</td><td><strong>1.57</strong></td></tr><tr><td>5</td><td>4.77</td><td>4.44</td><td>5.11</td><td><strong>1.61</strong></td></tr><tr><td>6</td><td>5.73</td><td>5.32</td><td>6.13</td><td><strong>1.81</strong></td></tr><tr><td>7</td><td>6.67</td><td>6.21</td><td>7.17</td><td><strong>2.28</strong></td></tr><tr><td>8</td><td>7.64</td><td>7.08</td><td>8.19</td><td><strong>2.39</strong></td></tr><tr><td>9</td><td>8.59</td><td>7.98</td><td>9.17</td><td><strong>2.75</strong></td></tr><tr><td>10</td><td>9.55</td><td>8.86</td><td>10.22</td><td><strong>2.89</strong></td></tr></tbody></table></div><p>从这个表格中我们可以看到，Python 3.13.0a5 在使用 <code>--disable-gil</code> 参数编译后，性能对比之前的版本有了比较明显的性能退步。这个原因是因为为了禁用 GIL，Python 引入了一些额外的锁开销，这导致了性能的下降。但是当我们使用 <code>-X gil=0</code> 参数来运行 Python 3.13.0a5 时，性能有了非常明显的提升，大概有 3 倍的性能提升。这说明 Python 3.13.0a5 的 GIL 禁用功能后并发性能上有了非常大的提升。当然，如果你不需要禁用 gil 的特性，在编译时一定不需要使用 <code>--disable-gil</code>，否则会有比较明显的性能下降。因为 Python 在每个版本种都会做很多性能优化，在使用新版本时，不禁用 GIL 的情况下，性能也会对比之前有略微的提升。</p><h2 id=总结>总结</h2><p>在这篇文章中，我们通过一个简单的多线程测试程序来测试 GIL 禁用的效果。通过对比，我们发现 Python 3.13.0a5 在启用 GIL 禁用编译参数后，较多线程运行的场景下，使用 <code>-X gil=0</code> 参数运行时，性能会出现较大提升。但是在单线程处理上由于为了保证出去 GIL 的安全性不得不做了很多妥协。因此在实际使用时，仍旧需要根据自身的使用场景，根据实际情况来选择是否禁用 GIL。</p></section><footer class=article-footer><section class=article-tags><a href=../../../tags/no-gil/>No-Gil</a>
<a href=../../../tags/python/>Python</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=../../../2019/01/2019-01-28-python-typing-with-stub-files/><div class=article-details><h2 class=article-title>利用Stub File标注Python文件</h2></div></a></article><article><a href=../../../2017/08/2017-08-02-install-face-recognition-on-osx/><div class=article-details><h2 class=article-title>OSX 下安装 face_recognition</h2></div></a></article><article><a href=../../../2017/02/2017-02-19-analyzing-pronto-cycleshare-data-with-python-and-pandas/><div class=article-details><h2 class=article-title>使用 Python 和 Pandas 分析 Pronto CycleShare 数据</h2></div></a></article><article><a href=../../../2016/09/2016-09-15-tracing-python-program-with-dtrace/><div class=article-details><h2 class=article-title>使用 dtrace 跟踪 Python 应用</h2></div></a></article><article><a href=../../../2016/07/2016-07-13-type-hint-improve-python-programming/><div class=article-details><h2 class=article-title>利用 Type Hint 提升 Python 程序开发效率</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//s1mbily.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2013 -
2024 ipfans's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.22.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=../../../ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>